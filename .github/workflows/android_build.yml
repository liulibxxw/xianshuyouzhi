
name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Install Dependencies
        run: npm install

      - name: Build Web Application
        run: npm run build

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Initialize Android Project
        run: |
          npx cap add android || echo "Android folder already exists"
          
          # 搜索 icon-only.png 文件
          ICON_PATH=$(find . -name "icon-only.png" | head -n 1)
          
          if [ -n "$ICON_PATH" ]; then
            echo "Icon found at $ICON_PATH. Generating density-specific icons..."
            RES_PATH="android/app/src/main/res"
            
            # 定义密度和对应的尺寸
            # mdpi: 48x48
            # hdpi: 72x72
            # xhdpi: 96x96
            # xxhdpi: 144x144
            # xxxhdpi: 192x192
            
            # 使用 ImageMagick 调整大小，确保侧边栏等组件能加载正确尺寸的图标
            
            mkdir -p "$RES_PATH/mipmap-mdpi"
            convert "$ICON_PATH" -resize 48x48 "$RES_PATH/mipmap-mdpi/ic_launcher.png"
            convert "$ICON_PATH" -resize 48x48 "$RES_PATH/mipmap-mdpi/ic_launcher_round.png"
            
            mkdir -p "$RES_PATH/mipmap-hdpi"
            convert "$ICON_PATH" -resize 72x72 "$RES_PATH/mipmap-hdpi/ic_launcher.png"
            convert "$ICON_PATH" -resize 72x72 "$RES_PATH/mipmap-hdpi/ic_launcher_round.png"
            
            mkdir -p "$RES_PATH/mipmap-xhdpi"
            convert "$ICON_PATH" -resize 96x96 "$RES_PATH/mipmap-xhdpi/ic_launcher.png"
            convert "$ICON_PATH" -resize 96x96 "$RES_PATH/mipmap-xhdpi/ic_launcher_round.png"
            
            mkdir -p "$RES_PATH/mipmap-xxhdpi"
            convert "$ICON_PATH" -resize 144x144 "$RES_PATH/mipmap-xxhdpi/ic_launcher.png"
            convert "$ICON_PATH" -resize 144x144 "$RES_PATH/mipmap-xxhdpi/ic_launcher_round.png"
            
            mkdir -p "$RES_PATH/mipmap-xxxhdpi"
            convert "$ICON_PATH" -resize 192x192 "$RES_PATH/mipmap-xxxhdpi/ic_launcher.png"
            convert "$ICON_PATH" -resize 192x192 "$RES_PATH/mipmap-xxxhdpi/ic_launcher_round.png"

            # 移除自适应图标定义 (Adaptive Icons) 及其所有干扰项
            # 删除此目录并清理默认资源，强制系统回退到常规的 ic_launcher.png
            rm -rf "$RES_PATH/mipmap-anydpi-v26"
            
            # 清理可能存在的默认 foreground 和 background 资源以及 webp 格式图标
            find "$RES_PATH" -name "ic_launcher_foreground.*" -delete
            find "$RES_PATH" -name "ic_launcher_background.*" -delete
            find "$RES_PATH" -name "ic_launcher*.webp" -delete
            
            echo "Icon generation complete."
          else
            echo "Error: icon-only.png not found in repository! Build cannot proceed without an icon."
            exit 1
          fi
          
          npx cap sync android

      - name: Build Debug APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
